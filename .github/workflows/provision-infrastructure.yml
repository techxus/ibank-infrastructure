name: Provision iBank Infrastructure
on:
  push:
    branches:
      - master
    paths-ignore:
      '.github/workflows/nuke-infrastructure.yml'

permissions:
  id-token: write
  contents: write

jobs:
  terragrunt:
    name: Terragrunt
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.99.4/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt --version

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      ############################################
      # Bootstrap runs first — always.
      # Ensures GitHub Actions role exists before
      # anything else runs. Self-healing after nuke.
      ############################################
      - name: Apply Bootstrap
        working-directory: bootstrap
        run: |
          terragrunt apply -auto-approve \
            --non-interactive

      - name: Terragrunt Apply
        run: |
          terragrunt run --all apply \
            --non-interactive

      - name: Upload errored state if apply fails
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: errored-tfstate
          path: '**/errored.tfstate'
          retention-days: 5

  generate-platform-config:
    name: Generate Platform Config
    runs-on: ubuntu-latest
    needs: terragrunt

    steps:
      - name: Checkout ibank-infrastructure
        uses: actions/checkout@v4

      - name: Checkout ibank-platform
        uses: actions/checkout@v4
        with:
          repository: techxus/ibank-platform
          token: ${{ secrets.PLATFORM_REPO_TOKEN }}
          path: ibank-platform

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Generate environment configs
        run: |
          get_param() {
            aws ssm get-parameter \
              --name "$1" \
              --query 'Parameter.Value' \
              --output text \
              --region us-east-1 2>/dev/null || echo ""
          }
          
          for ENV in dev stage prod; do
            REGION=$(get_param /ibank/$ENV/region)
          
            if [ -z "$REGION" ]; then
              echo "Skipping $ENV - SSM params not found"
              continue
            fi
          
            echo "Generating config for: $ENV"
          
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            DOMAIN=$(get_param /ibank/$ENV/domain)
            CLUSTER_NAME=$(get_param /ibank/$ENV/cluster-name)
            ACM_CERT_ID=$(get_param /ibank/$ENV/acm-certificate-id)
            VAULT_KMS_KEY_ID=$(get_param /ibank/$ENV/vault-kms-key-alias)
            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
            {
              echo "############################################"
              echo "# $ENV.yaml"
              echo "# AUTO-GENERATED by ibank-infrastructure pipeline"
              echo "# DO NOT EDIT MANUALLY"
              echo "# Last updated: $TIMESTAMP"
              echo "############################################"
              echo "env: $ENV"
              echo "region: $REGION"
              echo "domain: $DOMAIN"
              echo "accountId: \"$ACCOUNT_ID\""
              echo "clusterName: \"$CLUSTER_NAME\""
              echo "vaultKmsKeyId: \"$VAULT_KMS_KEY_ID\""
              echo "acmCertificateId: \"$ACM_CERT_ID\""
            } > ibank-platform/gitops/environments/$ENV.yaml
          
            echo "✓ Generated gitops/environments/$ENV.yaml"
          done

      - name: Commit and push
        run: |
          cd ibank-platform
          git config user.name "ibank-infrastructure-pipeline"
          git config user.email "pipeline@bankit.cloud"
          git add gitops/environments/
          git diff --staged --quiet || \
            git commit -m "chore: auto-generate environment configs from SSM"
          git push

  verify-platform:
    name: Verify Platform
    runs-on: ubuntu-latest
    needs: generate-platform-config

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install kubectl
        run: |
          curl -fsSL "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
            -o /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl

      - name: Make EKS public temporarily
        run: |
          aws eks update-cluster-config \
            --name ibank-dev-eks \
            --resources-vpc-config \
            endpointPublicAccess=true,endpointPrivateAccess=true \
            --region us-east-1
          echo "Waiting for endpoint..."
          sleep 90

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ibank-dev-eks \
            --region us-east-1

      - name: Check platform status
        run: |
          echo "=== ArgoCD Applications ==="
          kubectl get applications -n argocd
          
          echo "=== ArgoCD ApplicationSets ==="
          kubectl get applicationsets -n argocd
          
          echo "=== external-dns ==="
          kubectl get pods -n external-dns || echo "NOT INSTALLED"
          
          echo "=== Vault ==="
          kubectl get pods -n vault || echo "NOT INSTALLED"
          
          echo "=== Ingress ==="
          kubectl get ingress --all-namespaces
          
          echo "=== Route53 check ==="
          aws route53 list-resource-record-sets \
            --hosted-zone-id $(aws route53 list-hosted-zones \
              --query "HostedZones[?Name=='bankit.cloud.'].Id" \
              --output text | cut -d'/' -f3) \
            --query "ResourceRecordSets[?contains(Name,'argocd')]" \
            --output json

      - name: Check ArgoCD app details
        run: |
          echo "=== app-of-apps details ==="
          kubectl describe application app-of-apps -n argocd

          echo "=== ArgoCD repo server logs ==="
          kubectl logs -n argocd \
            deployment/argocd-repo-server \
            --tail=50

      - name: Make EKS private again
        if: always()
        run: |
          aws eks update-cluster-config \
            --name ibank-dev-eks \
            --resources-vpc-config \
            endpointPublicAccess=false,endpointPrivateAccess=true \
            --region us-east-1