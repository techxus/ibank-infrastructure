name: Verify Platform

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  verify:
    name: Verify Platform
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Install kubectl
        run: |
          curl -fsSL "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
            -o /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl

      - name: Make EKS public temporarily
        run: |
          aws eks update-cluster-config \
            --name ibank-dev-eks \
            --resources-vpc-config \
            endpointPublicAccess=true,endpointPrivateAccess=true \
            --region us-east-1
          echo "Waiting for endpoint..."
          sleep 90

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ibank-dev-eks \
            --region us-east-1

      - name: Cluster info
        run: |
          echo "=== Nodes ==="
          kubectl get nodes

          echo "=== OIDC Issuer ==="
          aws eks describe-cluster --name ibank-dev-eks \
            --query 'cluster.identity.oidc.issuer' --output text

          echo "=== OIDC Providers in IAM ==="
          aws iam list-open-id-connect-providers

      - name: ArgoCD status
        run: |
          echo "=== Applications ==="
          kubectl get applications -n argocd

          echo "=== ApplicationSets ==="
          kubectl get applicationsets -n argocd

          echo "=== ArgoCD pods ==="
          kubectl get pods -n argocd

      - name: Platform components
        run: |
          echo "=== ALB Controller ==="
          kubectl get pods -n kube-system | grep -i alb || echo "NOT FOUND"

          echo "=== external-dns ==="
          kubectl get pods -n external-dns || echo "NOT INSTALLED"

          echo "=== Ingress ==="
          kubectl get ingress --all-namespaces

          echo "=== Route53 records ==="
          aws route53 list-resource-record-sets \
            --hosted-zone-id $(aws route53 list-hosted-zones \
              --query "HostedZones[?Name=='bankit.cloud.'].Id" \
              --output text | cut -d'/' -f3) \
            --query "ResourceRecordSets[?contains(Name,'bankit.cloud')].[Name,Type]" \
            --output table

      - name: Test IRSA
        run: |
          echo "=== Service Account ==="
          kubectl get serviceaccount external-dns-dev -n external-dns -o yaml

          echo "=== Token claims ==="
          kubectl create token external-dns-dev \
            --namespace external-dns \
            --audience sts.amazonaws.com \
            --duration 600s | cut -d. -f2 | \
            python3 -c "import sys,base64,json; d=sys.stdin.read().strip(); p=d+'=='*3; print(json.dumps(json.loads(base64.urlsafe_b64decode(p[:len(p)-len(p)%4])),indent=2))"

          echo "=== STS AssumeRoleWithWebIdentity ==="
          TOKEN=$(kubectl create token external-dns-dev \
            --namespace external-dns \
            --audience sts.amazonaws.com \
            --duration 600s)
          aws sts assume-role-with-web-identity \
            --role-arn arn:aws:iam::121897425968:role/ibank-dev-external-dns \
            --role-session-name test-irsa \
            --web-identity-token "$TOKEN" \
            --duration-seconds 900

      - name: external-dns logs
        run: |
          kubectl logs -n external-dns \
            deployment/external-dns-dev \
            --tail=50